

<!doctype html>
<html class="no-js">
<head>
	
	<meta charset="utf-8">
	
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache"> 
	<meta http-equiv="Expires" content="0">
	
	
	
	<meta name="description" content="集享卡商城，全家、德克士、康师傅让你爽翻天">
	
	<meta name="keywords" content="商城，集享卡，网上购物，全家，德克士，康师傅私房牛肉面">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	
	
	
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	
	<link rel="icon" type="image/png" href="https://image.maxxipoint.com/static/OnlineStore/assets/i/favicon.png">
	<link rel="stylesheet" href="https://image.maxxipoint.com/static/OnlineStore/assets/css/amazeui.min.css?v1.3.5.2">
	<link rel="stylesheet" href="https://image.maxxipoint.com/static/OnlineStore/assets/css/base.css?v1.3.5.2">
	
	<script type='text/javascript'>
	    var memberId = '1134225638';
	    var _vds = _vds || [];
	    window._vds = _vds;
	    (function(){
	      _vds.push(['setAccountId', '8461b819f5734773']);
	      if(memberId!=""&&memberId!=null){
	          _vds.push(['setCS1', 'memberId', memberId]);
	      }
	      (function() {
	        var vds = document.createElement('script');
	        vds.type='text/javascript';
	        vds.async = true;
	        vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
	        var s = document.getElementsByTagName('script')[0];
	        s.parentNode.insertBefore(vds, s);
	      })();
	    })();
	</script>
    <title>购物车</title>
    <link rel="stylesheet" href="https://image.maxxipoint.com/static/OnlineStore/css/checkbox.css?v1.3.5.2"/>
    <link rel="stylesheet" href="https://image.maxxipoint.com/static/OnlineStore/css/order/shopping.css?v1.3.5.2">
</head>
	
<body>
    <!-- 头部 -->
    <!-- <div class="header wm-size18 wm-border-bottom">
        <a href="" class="am-fl wm-ft-32"><i class="am-icon-angle-left  am-icon-md wm-mrg-top-less4"></i></a>
        <span>我的购物车</span>
        <a href="#" class="am-fr wm-ft-32 wm-size20"><i class="am-icon-list-ul"></i></a>
         <a class="start-update" onclick="startUpdateNum()">编辑</a>
        <a class="end-update" onclick="endUpdateNum()">完成</a> 
    </div>
    <br>
    <br>
    <br> -->
    <!-- 头部结束 -->
   
    <div class="ui-header"></div>
    
    <!-- 底部结算条 -->
    <div id="shopping-footer" class="am-g wm-color-alpha8 add-new wm-ft-fe wm-padding-top10">
        <div class="am-u-sm-4 wm-padding0 wm-padding-left5 wm-size10 ui-checkbox2" style="width:20%;text-align:center;">
            <input type="checkbox" checked="checked" style="height:14px;width:14px;"class="ui-checkbox" id="on-select-all">
            <label for="on-select-all"></label>
            &nbsp;<span style="color:black;" class="wm-size14">全选</span>&nbsp;&nbsp;
            
        </div>
        <div class="am-u-sm-5 wm-padding0 wm-size10" style="width:50%;text-align:center;">
            <span style="color:black;">合计：</span><span class="wm-ft-red wm-size14" id="on-count-price">&yen;0.00</span>
        </div>
        <div  id="on-button-settle"  style="float:left;width:30%;text-align:center;background-color:#D92818;height:100%;">
        	去结算(<span id="on-count-num"></span>)
          <!--   <button type="button" onclick="Settlement()" id="on-button-settle" class="am-btn am-btn-block wm-color-red wm-ft-fe wm-ridus4">去结算</button> -->
        </div>
    </div>
    <div class="am-g wm-color-alpha8 add-new wm-ft-fe wm-padding-top10 bottom-clear-strip">
    </div>
    <!-- 底部结束 -->
    <!-- 模态窗口 -->
    <div class="am-modal am-modal-no-btn am-g" tabindex="-1" id="doc-modal-1">
        <div class="am-modal-dialog am-u-sm-8 am-u-sm-centered">
            <div class="am-modal-hd">
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div class="am-modal-bd am-g">
                <br>
                <div class="am-u-sm-2"><i class="am-icon-info-circle am-icon-md wm-ft-yellow"></i></div>
                <div class="am-u-sm-10 am-text-left">
                    <p>确定要删除此商品吗？</p>
                </div>
                <div class="am-u-sm-5 wm-top20" style="    margin-left: -3.5rem;">
                    <button type="button" class="am-btn wm-color-fe wm-border-e0 wm-ridus4 am-btn-block" data-am-modal-close>取消</button>
                </div>
                <div class="am-u-sm-2"></div>
                <div class="am-u-sm-5 wm-top20" >
                    <button type="button" class="am-btn am-btn-block wm-color-red wm-ridus4 wm-ft-fe" id="on-order-del">确定</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="am-modal am-modal-no-btn am-g" tabindex="-1" id="doc-modal-mes">
        <div class="am-modal-dialog am-u-sm-8 am-u-sm-centered">
            <div class="am-modal-hd">
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div class="am-modal-bd am-g">
                <br>
                <div class="am-u-sm-2"><i class="am-icon-info-circle am-icon-md wm-ft-yellow"></i></div>
                <div class="am-u-sm-10 am-text-left">
                    <p id="on-p-mes"></p>
                </div>
                <div class="am-u-sm-12 wm-top20">
                    <button type="button" class="am-btn wm-border-e0 wm-ridus4 am-btn-block wm-color-red wm-ft-fe" data-am-modal-close>确定</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="am-modal am-modal-no-btn am-g" tabindex="-1" id="doc-modal-error">
        <div class="am-modal-dialog am-u-sm-8 am-u-sm-centered">
            <div class="am-modal-hd">
                <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
            </div>
            <div class="am-modal-bd am-g">
                <br>
                <div class="am-u-sm-2"><i class="am-icon-info-circle am-icon-md wm-ft-yellow"></i></div>
                <div class="am-u-sm-10 am-text-left">
                    <p id="on-p-error"></p>
                </div>
                <div class="am-u-sm-12 wm-top20">
                    <button type="button" onclick="onResetPage()" class="am-btn wm-border-e0 wm-ridus4 am-btn-block wm-color-red wm-ft-fe">确定</button>
                </div>
            </div>
        </div>
    </div>
    
     <div class="am-modal am-modal-loading am-modal-no-btn" tabindex="-1" id="doc-modal-loading">
	  <div class="am-modal-dialog">
	    <div class="am-modal-hd">正在加载中...</div>
	    <div class="am-modal-bd">
	      <span class="am-icon-spinner-loading"></span>
	    </div>
	  </div>
	</div>
    <!-- end 模态窗口 -->
    <!--[if (gte IE 9)|!(IE)]><!-->
 <script src="https://image.maxxipoint.com/static/OnlineStore/assets/js/jquery-1.7.2.min.js?v1.3.5.2"></script>
 <script src="https://image.maxxipoint.com/static/OnlineStore/assets/js/amazeui.min.js?v1.3.5.2"></script>
 <script src="//res.wx.qq.com/open/js/jweixin-1.0.0.js?v1.3.5.2"></script>
  
  
   <script type="text/javascript" >
       function goback(){
    	 if(!(window.history.go(-1))){
    			 appToIndex()
        }
        }
       function appToIndex(){
    	   window.location.href='toIndex.do';
        }

       function share(){
	       try{
	           var p = 'eyJzaGFyZVN0YXR1cyI6MH0=';
		       
					window.location.href='nexusshare://shareContent?params='+'eyJzaGFyZVN0YXR1cyI6MH0=';
		       
		       
	        }catch(e){
	            
	        }
       }
       var appversion = '3.2.5';
       if(appversion) appversion = (appversion.replace(/\./g,''));
       if(appversion&&parseInt(appversion)>322){
		       setTimeout(share,100);
       }
  </script>
   
    <script>
    $(function() {
    	$("#doc-modal-loading").modal('open');
        /* 加载购物车信息 */
        getShopCart();
        $('#on-button-settle').on('click',function(){Settlement();});
    });
    function onResetPage(){
    	window.location.reload();
    }
    function startother(){
    	//全选或全不选
        $("#on-select-all").click(function() {
        	var _node = $('#on-button-settle');
            if (this.checked) {
                $("body :checkbox").attr("checked", true);
                _node.css('backgroundColor','#D92818').on('click',function(){Settlement();});;
            } else {
                $("body :checkbox").attr("checked", false);
                _node.css('backgroundColor','#eee').off('click');
            }
        });
        //点击确认删除商品
        $("#on-order-del").click(function() {
       		/* var productId = $(this).val().split(",")[1];
           	var index = $(this).val().split(",")[0];
            $("#on-product-st-"+index).remove();
            
           	 删除商品后重新计算总价 
            countNumAndPrice(); */
            /* 删除后修改后台数据 */
            $("#doc-modal-1").modal('close');
            updateRedis("delpro",this);
        });
        //修改总价和总数量
        $(":checkbox").click(function(){
        	countNumAndPrice();
        });
        
        /* 页面加载完后计算总价 */
        countNumAndPrice();
    }
    
    function getShopCart(){
    	var url = "/OnlineStore/getShopCart.do";
    	$.ajax({
            type: "POST",
            url: url,
            data: "",
            /* async: false, */
            cache: false,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded;charset=utf-8",
            success: function(data) {
            	var html = "";
            	if(data.result==0){
	            	for(var i = 0;i<data.size;i++){
	            		var product = data[i];
	            		if(product==undefined){
		            		continue;
		            	}
	            		var buyType = product.buyType;
	            		var maxBuyNum = product.maxBuyNum;
	            		var pricehtml = "";
	            		var maxBuyNumHtml = "";
	            		var shixiaoHtml = "";
	            		var guige1 = product.guige1;
	            		var guige2 = product.guige2;
	            		if(!guige2) guige2 = '';
	            		if(!guige1) guige1 = '';
	            		var countprice = null;
	            		if(maxBuyNum!=undefined){
	            			maxBuyNumHtml = "max=\""+product.maxBuyNum+"\"data-maxbuynum="+product.maxBuyNum;
	            		}
	            		if(product.productStatus==1){
	            			shixiaoHtml="<img src=\"https://image.maxxipoint.com/static/OnlineStore/images/product_status/yixiajia.png\" class=\"maiwanle2\"></img>";
	            		}
	            		if(product.productStatus==2){
	            			shixiaoHtml="<img src=\"https://image.maxxipoint.com/static/OnlineStore/images/product_status/maiwanla.png\" class=\"maiwanle2\"></img>";
	            		}
	            		
	            		/* switch(buyType){
	            		case 0:
	            			countprice = "<span class=\"wm-ft-red am-fr one-total-price-"+i+"\">&yen;"+(product.nowPrice*product.productNum).toFixed(2)+"</span>";
	                		break;
	                	case 1:
	                		countprice = "<span class=\"wm-ft-red am-fr one-total-price-"+i+"\">&yen;"+(product.nowPrice*product.productNum).toFixed(2)+"<br/>+"+(product.pointPrice*product.productNum)+"积分</span>";
	                		break;
	                	case 2:
	                		countprice = "<span class=\"wm-ft-red am-fr one-total-price-"+i+"\">"+(product.pointPrice*product.productNum)+"积分</span>";
	                		break;
	            		} */
	            		switch(buyType){
	            		case 0:
	            			countprice = "&yen;"+(product.nowPrice*product.productNum).toFixed(2);
	                		break;
	                	case 1:
	                		countprice = "&yen;"+(product.nowPrice*product.productNum).toFixed(2)+"+"+(product.pointPrice*product.productNum)+"积分";
	                		break;
	                	case 2:
	                		countprice = (product.pointPrice*product.productNum)+"积分";
	                		break;
	            		}
	            		var activity = "";
	            		if ('undefined' != typeof product.activity) {
	            			activity = '<span class="ask-ui-man" style="margin-left:6px;height:100%;overflow:hidden;">' + product.activity.actName + '</span>';
	            		}
	            		pricehtml = '<p class="wm-size12 wm-ft-red one-price-count">' + countprice +'&nbsp;' + activity +'</p>';
	            		html+="<div class=\"am-g wm-color-fe wm-border2 on-one-product ui-checkbox\" style=\"position: relative;padding:1.5rem 0 1rem 0;\" id=\"on-product-st-"+i+"\">"+shixiaoHtml+
	            			/*   "<hr class=\"am-divider\">"+ */
	            	          "<div style='width:11%;' class=\"am-u-sm-1 wm-padding10\">"+
	            	          "<input type=\"checkbox\" name='orderData' id='orderList_"+i+"' class=\"check-order-list\" checked=\"checked\"><label for='orderList_"+i+"'></label>"+
	            	          "</div>"+
	            	          "<div class=\"am-u-sm-2 wm-padding0\">"+
	            	          "<img src=\"https://image.maxxipoint.com/mall"+product.picCover+"\" class=\"wm-width100\">"+
	            	          "</div>"+
	            	          "<div class=\"am-u-sm-7 wm-padding-bottom10\">"+
	            	          "<p class=\"wm-size12\">"+product.productName+" "+guige1+" "+guige2+"</p>"+pricehtml+
	            	          "<div class=\"am-u-sm-4 ipt-group\">"+
	            	          "<input type=\"hidden\" id=\"productId\" value=\""+product.productId+"\">"+
	            	          "<input type=\"hidden\" id=\"nowPrice\" value=\""+product.nowPrice+"\">"+
	            	          "<input type=\"hidden\" id=\"pointPrice\" value=\""+product.pointPrice+"\">"+
	            	          "<input type=\"hidden\" id=\"buyType\" value=\""+buyType+"\">"+
	            	          "<input type=\"hidden\" id=\"productStatus\" value=\""+product.productStatus+"\">"+
	            	          "<span class=\"ipt-flt ipt-span\" onclick=\"minusNum(this,"+product.nowPrice+","+i+","+buyType+","+product.pointPrice+")\">"+    
	            	          "<i class=\"add_num\">-</i>"+    
	            	          "</span>"+
	            	          "<input type=\"text\" id=\"productNum\" "+maxBuyNumHtml+" data-tolnum="+product.tolNum+" class=\"ipt-flt ipt-ip one-num-"+i+"\" onkeypress=\"return isNum(this)\" onBlur=\"checkNum(this,"+i+","+product.nowPrice+","+buyType+","+product.pointPrice+")\" oninput=\"numChange(this,"+i+","+product.nowPrice+","+buyType+","+product.pointPrice+")\" value=\""+product.productNum+"\">"+
	            	          "<span class=\"ipt-flt ipt-span\" onclick=\"addNum(this,"+product.nowPrice+","+i+","+buyType+","+product.pointPrice+")\">"+    
	            	          "<i class=\"add_num\">+</i>"+    
	            	          "</span>"+
	            	          "</div>"+
	            	          "<div class=\"am-u-sm-4 ipt-group-default\">"+
	            	          "<span class=\"defaule-one-num-"+i+"\">&times;"+product.productNum+"</span>"+
	            	          "</div>"+
	            	          "</div>"+
	            	          "<div class=\"am-u-sm-2 wm-padding10 am-text-right wm-ft-red\" style='width:10%;padding-top:0;'>"+
	            	          "<p data-am-modal=\"{target: '#doc-modal-1', width: 400, height: 150}\">"+
	            	          "<img src=\"https://image.maxxipoint.com/static/OnlineStore/images/icon-del2.png\" onclick=\"deleteProduct("+i+","+product.productId+")\" class=\"icon wm-top-less4\">"+
	            	          "</p>"+
	            	          "<p style='display:none;' class=\"wm-top15 wm-size12\">"+countprice+
	            	          "</p>"+
	            	          "</div>"+
	            	          "</div>";
	            	}
	            	//加载完成以后打开编辑界面
	            }else if(data.result==1){
                  //  setTimeout(getShopCart,1000);
                    return;
	            	html +='<div style="text-align:center;margin-top:15%;"><img width="40%" src="https://image.maxxipoint.com/static/OnlineStore/images/cart_e.png" /><p style="font-weight:500;margin-top:1rem;">购物车空空如也</p></div><div class="ui-shopping-bu"><a style="color:#fff;" href=\"/OnlineStore/toIndex.do\" style=\"font-size:1.6rem;margin-top:1em;font-weight:bold;\">去逛逛</a></div>'
	            	/* html += "<div style=\"text-align: center;margin-top:3em;\"><h1>购物车空空如也</h1><br/>"+
	            	"<a href=\"/OnlineStore/toIndex.do\" style=\"font-size:1.8em;margin-top:1em;font-weight:bold;\">去逛逛</a></div>"+ */
	            	+ "<div style=\"text-align:center;\"><span id=\"jumpTo\" style=\"color:#D9534F;font-size:150%;font-weight:blod;margin:8px 8px;\">5</span>秒后自动跳到我的订单</div>";
	            	//countTime(5,'/OnlineStore/toMyOrder.do');
                    html="";
	            }else{
                   // setTimeout(getShopCart,1000);
                    return;
	            	html +='<div style="text-align:center;margin-top:15%;"><img width="40%" src="https://image.maxxipoint.com/static/OnlineStore/images/cart_e.png" /><p style="font-weight:500;margin-top:1rem;">购物车空空如也</p></div><div class="ui-shopping-bu"><a style="color:#fff;" href=\"/OnlineStore/toIndex.do\" style=\"font-size:1.6rem;margin-top:1em;font-weight:bold;\">去逛逛</a></div>';
	            	html="";
	            	/* html += "<div style=\"text-align: center;margin-top:3em;\"><h1>购物车空空如也</h1><br/>"+
	            	"<a href=\"/OnlineStore/toIndex.do\" style=\"font-size:1.8em;margin-top:1em;font-weight:bold;\">去逛逛</a></div>"; */
//	            	$('#shopping-footer').hide();
	            }
            	$(".ui-header").after(html);
            	startother();
            	//渲染完毕打开编辑
            	startUpdateNum();
            	$("#doc-modal-loading").modal("close");
            	
            },
            error: function(xhr){
            	$("#doc-modal-loading").modal("close");
            	if(xhr.status==0){
	        		$("#on-p-mes").html("网络异常");
	        		$("#doc-modal-mes").modal("open");
        		}else{
        			$("#on-p-mes").html("系统错误");
	        		$("#doc-modal-mes").modal("open");
        		}
            }
        }); 
    }
    
    
    
   	/* 商品数量加1 */
    function addNum(element,price,index,buyType,pointPrice){
   		/* 这里直接从html中传过来的元素需要加上$()符才能在jquery中正常使用 
   		同时这里是通过当前元素查找父元素兄弟元素的方式来找到商品数量那个元素*/
    	/* var num = $(element).parent().find("input[class*='ipt-ip']");  */
    	/* 这里是通过生成html元素时动态的添加了下标来标示是第几个生成的元素区域，然后直接通过选择器找到商品数量那个元素 */
    	var num = $(".one-num-"+index);
    	var maxnum = $(element).parent().parent().find("#productNum").data("maxbuynum");
    	var tolnum = $(element).parent().parent().find("#productNum").data("tolnum");
    	
    	if(maxnum!=undefined){
    		if(maxnum<=tolnum){
    			if(parseInt(num.val())>=maxnum){
    				num.val(maxnum);
        	    	//同时把默认显示的数量修改
        	    	$(".defaule-one-num-"+index).html("&times;"+num.val());
        	    	/* var div = $(element).parent().parent().next().find("span[class*='one-total-price']"); */
        	    	var div = $(".one-total-price-"+index);
        	    	setOnePrice(div,price,num.val(),buyType,pointPrice); 
        			$("#on-p-mes").html("超过限购数量");
            		$("#doc-modal-mes").modal("open");
        			return;
        	    };
    		}else{
    			if(parseInt(num.val())>=tolnum){
    				num.val(tolnum);
        	    	//同时把默认显示的数量修改
        	    	$(".defaule-one-num-"+index).html("&times;"+num.val());
        	    	/* var div = $(element).parent().parent().next().find("span[class*='one-total-price']"); */
        	    	var div = $(".one-total-price-"+index);
        	    	setOnePrice(div,price,num.val(),buyType,pointPrice); 
        			
        			$("#on-p-mes").html("超过库存数量");
            		$("#doc-modal-mes").modal("open");
        			return;
        	    };
    		};
    	}else{
    		if(parseInt(num.val())>=tolnum){
    			num.val(tolnum);
    	    	//同时把默认显示的数量修改
    	    	$(".defaule-one-num-"+index).html("&times;"+num.val());
    	    	/* var div = $(element).parent().parent().next().find("span[class*='one-total-price']"); */
    	    	var div = $(".one-total-price-"+index);
    	    	setOnePrice(div,price,num.val(),buyType,pointPrice); 
    			
    			$("#on-p-mes").html("超过库存数量");
        		$("#doc-modal-mes").modal("open");
    			return;
    	    };
    	}
    	//限制输入超过99
    	if(parseInt(num.val())==99){
	    	return;
	    }
    	num.val(parseInt(num.val())+1);
    	//同时把默认显示的数量修改
    	$(".defaule-one-num-"+index).html("&times;"+num.val());
    	/* var div = $(element).parent().parent().next().find("span[class*='one-total-price']"); */
    	var div = $(".one-total-price-"+index);
    	setOnePrice(div,price,num.val(),buyType,pointPrice); 
    	updateRedis("updnum");
    }
    /* 商品数量减一 */
    function minusNum(element,price,index,buyType,pointPrice){
    	/* var num = $(element).parent().find("input[class*='ipt-ip']");  */
    	var num = $(".one-num-"+index);
    	var maxnum = $(element).parent().parent().find("#productNum").data("maxbuynum");
    	var tolnum = $(element).parent().parent().find("#productNum").data("tolnum");
    	if(num.val()==1) return;
    	if(maxnum!=undefined){
    		if(maxnum<=tolnum){
    			if(parseInt(num.val())>maxnum){
    				num.val(maxnum);
        	    	//同时把默认显示的数量修改
        	    	$(".defaule-one-num-"+index).html("&times;"+num.val());
        	    	/* var div = $(element).parent().parent().next().find("span[class*='one-total-price']"); */
        	    	var div = $(".one-total-price-"+index);
        	    	setOnePrice(div,price,num.val(),buyType,pointPrice); 
        			$("#on-p-mes").html("超过限购数量");
            		$("#doc-modal-mes").modal("open");
        			return;
        	    };
    		}else{
    			if(parseInt(num.val())>tolnum){
    				num.val(tolnum);
        	    	//同时把默认显示的数量修改
        	    	$(".defaule-one-num-"+index).html("&times;"+num.val());
        	    	/* var div = $(element).parent().parent().next().find("span[class*='one-total-price']"); */
        	    	var div = $(".one-total-price-"+index);
        	    	setOnePrice(div,price,num.val(),buyType,pointPrice); 
        			
        			$("#on-p-mes").html("超过库存数量");
            		$("#doc-modal-mes").modal("open");
        			return;
        	    };
    		};
    	}else{
    		if(parseInt(num.val())>tolnum){
    			num.val(tolnum);
    	    	//同时把默认显示的数量修改
    	    	$(".defaule-one-num-"+index).html("&times;"+num.val());
    	    	/* var div = $(element).parent().parent().next().find("span[class*='one-total-price']"); */
    	    	var div = $(".one-total-price-"+index);
    	    	setOnePrice(div,price,num.val(),buyType,pointPrice); 
    			
    			$("#on-p-mes").html("超过库存数量");
        		$("#doc-modal-mes").modal("open");
    			return;
    	    };
    	}
    	if(parseInt(num.val())<=1){
			num.val(1);
	    }else{
    		num.val(parseInt(num.val())-1); 
    	}
		$(".defaule-one-num-"+index).html("&times;"+num.val());
		/* var div = $(element).parent().parent().next().find("span[class*='one-total-price']"); */
    	var div = $(".one-total-price-"+index);
		setOnePrice(div,price,num.val(),buyType,pointPrice);
		updateRedis("updnum"); 
    }
    /* 手动修改商品数量 */
    function numChange(element,index,price,buyType,pointPrice){
 		var num = $(element).val();
 		var maxnum = $(element).data("maxbuynum");
 		var tolnum = $(element).data("tolnum");
 		//如果用户首位输入0就改成1
    	if(num.length==1){
    		if(num==0){
    			num=1;
    		}
    	} 
    	if(maxnum!=undefined){
    		if(maxnum<=tolnum){
    			if(num>maxnum){
    				num=maxnum;
        			$(element).val(num);
        			$(".defaule-one-num-"+index).html("&times;"+num);
         	 		setOnePrice($(".one-total-price-"+index),price,num,buyType,pointPrice);
         	 		$("#on-p-mes").html("超过限购数量");
            		$("#doc-modal-mes").modal("open");
        			return;
        	    };
    		}else{
    			if(num>tolnum){
    				num=tolnum;
    	 			$(element).val(num);
    	 	 		$(".defaule-one-num-"+index).html("&times;"+num);
    	 	 		setOnePrice($(".one-total-price-"+index),price,num,buyType,pointPrice);
    	 	 		$("#on-p-mes").html("超过库存数量");
    	    		$("#doc-modal-mes").modal("open");
    				return;
        	    };
    		};
    	}else{
    		if(num>tolnum){
    			num=tolnum;
	 			$(element).val(num);
	 	 		$(".defaule-one-num-"+index).html("&times;"+num);
	 	 		setOnePrice($(".one-total-price-"+index),price,num,buyType,pointPrice);
	 	 		$("#on-p-mes").html("超过库存数量");
	    		$("#doc-modal-mes").modal("open");
				return;
    	    };
    	}
    	//如果数量大于99就改成99
    	if(num>99){
    		num=99;
    	}
    	//这里不能在num==0时做限制，因为当用户手输input框的内容是，删除第一个数字会限制住
    	if(num<0){
    		num=1;
    	} 
    	//如果数量超过最大值或最小值，就要重新设下input框中的value值
    	$(element).val(num);
 		$(".defaule-one-num-"+index).html("&times;"+num);
 		setOnePrice($(".one-total-price-"+index),price,num,buyType,pointPrice);
 		updateRedis("updnum");
    }
    /* 修改单件商品总价 */
    function setOnePrice(div,price,num,buyType,pointPrice){
    	if(buyType==0){
    		div.html("&yen;"+(price*num).toFixed(2));
    	}
    	if(buyType==1){
    		console.log((price*num).toFixed(2));
    		console.log(pointPrice*num);
    		div.html("&yen;"+(price*num).toFixed(2)+"<br/>+"+(pointPrice*num)+"积分");
    	}
    	if(buyType==2){
    		div.html((pointPrice*num)+"积分");
    	}
    	countNumAndPrice();
    }
    /* 开始编辑商品数量 */
    function startUpdateNum(){
    	$(".ipt-group").css("display","block");
    	$(".ipt-group-default").css("display","none");
    }
    /* 结束编辑商品数量 */
    function endUpdateNum(){
    	/* $("#productNum").each(function(){
    		if($(this).val()<=0){
    			$("#on-p-mes").html("商品数量不符合格式");
        		$("#doc-modal-mes").modal('open');
        		return;
    		}
    	});
    	$(".bottom-clear-strip").css("display","none");
    	$(".start-update").css("display","block");
    	$(".end-update").css("display","none");
    	$(".ipt-group").css("display","none");
    	$(".ipt-group-default").css("display","block");
    	编辑完商品数量后要重新计算总量和总价 
    	countNumAndPrice(); */
    	
    	/* 修改后台redis中的购物车对象 */
    	updateRedis("updnum");
    }
    /* 统计商品总数和总价 */
    function countNumAndPrice(){
    	var countNum = 0;
    	var countPrice = 0;
    	var countpointPrice = 0;
    	var _length = $(".on-one-product input[type='checkbox']").length;
    	var _temp = _length;
    	var _maxTemp = 0;
    	$(".on-one-product input[type='checkbox']").each(function(k,v){
    		/* jquery 1.6版本之后attr("checked")返回的不再是true和false */
    		if($(this).attr("checked")=="checked"){
    			++_maxTemp;
    			//var price = parseFloat($(this).parent().parent().find(".one-price-count").html().replace("&yen;",""));
    			var num = parseFloat($(this).parent().parent().find("#productNum").val());
    			var buyType = $(this).parent().parent().find("#buyType").val();
    			var price = parseFloat($(this).parent().parent().find("#nowPrice").val());
    			var pointPrice = $(this).parent().parent().find("#pointPrice").val();
    			if(buyType==0){
    				countPrice+=price*num;
        			countNum+=num;
    	    	}
    	    	if(buyType==1){
    	    		countPrice+=price*num;
    	    		countpointPrice+=pointPrice*num;
        			countNum+=num;
    	    	}
    	    	if(buyType==2){
    	    		countpointPrice+=pointPrice*num;
        			countNum+=num;
    	    	}
    			
    		}else{
    			--_temp;
    		}
    	});
    	if(_maxTemp>0){
    		  $('#on-button-settle').css('backgroundColor','#D92818').on('click',function(){Settlement();});
    		  if(_maxTemp == _length){
    			  $("body :checkbox").attr("checked", true);
    		  }
    	}
    	if(_temp==0){
    		  $("body :checkbox").attr("checked", false);
              $('#on-button-settle').css('backgroundColor','#eee').off('click');
    	}
    	$("#on-count-num").html(countNum);
    	if(countpointPrice==0){
    		$("#on-count-price").html("&yen;"+countPrice.toFixed(2)); 
    	}else if(countPrice==0){
    		$("#on-count-price").html(countpointPrice+"积分"); 
    	}else{
    		$("#on-count-price").html("&yen;"+countPrice.toFixed(2)+"+"+countpointPrice+"积分");
    	}
    }
    /* 点击删除图标时，把当前的div序号和商品Id保存到模态框中确定按钮元素的value中 */
    function deleteProduct(index,productId){
    	$("#on-order-del").val(index+","+productId);
    }
    function countTime(secs,surl){
    	setTimeout("countDown("+secs+",'"+surl+"')",10);  
    }
    function countDown(secs,surl){     
   	 //alert(surl);     
   	 var jumpTo = document.getElementById('jumpTo');
   	 jumpTo.innerHTML=secs;  
   	 if(--secs>0){     
   	     setTimeout("countDown("+secs+",'"+surl+"')",1000);     
   	 }    
   	 else{       
   	     location.href=surl;     
   	 }    
   	 }  
    //限制用户输入数字，不能输入字符
    function isNum(e){
    	var k = event.keyCode;
        if (((k >= 48) && (k <= 57))) {
        	
        } else {
            if (window.event) {
                window.event.returnValue = false;
            }
            else {
                e.preventDefault(); //for firefox 
            }
        }
    }  
    /* function isNum(e) {
        var k = window.event ? e.keyCode : e.which;
        if (((k >= 48) && (k <= 57))) {
        } else {
            if (window.event) {
                window.event.returnValue = false;
            }
            else {
                e.preventDefault(); //for firefox 
            }
        }
    } */
    //输入框失去焦点后校验数量
    function checkNum(element,index,price,buyType,pointPrice){
    	var num = $(element).val();
    	/* if(num<=0){
    		num = 1;
    		$(element).val(num);
     		$(".defaule-one-num-"+index).html("&times;"+num);
     		setOnePrice($(".one-total-price-"+index),num,price,buyType,pointPrice);
    	} */
    	//这里Num是String类型，所以不用先转化，  如果是int型的话传过来01会变成1
    	//如果input框中的数据格式不合法就改成1
    	if(!isInteger(num)){
    		num = 1;
    		$(element).val(num);
     		$(".defaule-one-num-"+index).html("&times;"+num);
     		setOnePrice($(".one-total-price-"+index),num,price,buyType,pointPrice);
    	}
    }
    //判断字符串是否为1到9开头的纯数字
    function isInteger(str){
    	var regexStr = /^[1-9][0-9]*$/;
    	return regexStr.test(str);
    }
    
    function updateRedis(operating,element){
    	$("#doc-modal-loading").modal("open");
    	console.log(element);
    	var exproductId;
    	if(operating=='delpro'){
    		exproductId = $(element).val().split(",")[1];
    	}
    	/* 组装成这样的json"{\"openId\":\"oin0iuH35lH2PwGVznmvnnJ6UE4Q\",\"product\":[{\"num\":2,\"id\":2},{\"num\":1,\"id\":4}]}" */;
    	var shopcartstr = "";
    	$(".on-one-product").each(function(){
    		var productNum = $(this).find("#productNum").val();
    		var productId = $(this).find("#productId").val();
    		if(productId!=exproductId){
	    		var productStatus = $(this).find("#productStatus").val();
	    		/* shopcartstr += "{\"num\":"+productNum+",\"id\":"+productId+",\"status\":"+productStatus+"},"; */
	    		shopcartstr += "{\"num\":"+productNum+",\"id\":"+productId+"},";
    		} 
    	});
    	if(shopcartstr!=""){
    		/* shopcartstr = "{\"product\":["+shopcartstr.substring(0,shopcartstr.length-1)+"]}"; */
    		shopcartstr = "{\"product\":["+shopcartstr.substring(0,shopcartstr.length-1)+"],\"openId\":\"1134225638\"}";
    	}
    	var url = "/OnlineStore/updateShopCart.do";
    	$.ajax({
            type: "POST",
            url: url,
            data: "shopcartstr="+shopcartstr,
            /* async: false, */
            cache: false,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded;charset=utf-8",
            success: function(data) {
        	   if(data.result=="login"){
        		login(data);
        	   }else if(operating=='delpro'){
                   	var index = $(element).val().split(",")[0];
                    $("#on-product-st-"+index).remove();
                   	/* 删除商品后重新计算总价 */
                    countNumAndPrice();	
                    $("#doc-modal-1").modal('close');
            	}else if(operating=='updnum'){
            		$("#productNum").each(function(){
                		if($(this).val()<=0){
                			$("#on-p-mes").html("商品数量不符合格式");
                    		$("#doc-modal-mes").modal('open');
                    		return;
                		}
                	});
  /*               	$(".bottom-clear-strip").css("display","none");
                	$(".start-update").css("display","block");
                	$(".end-update").css("display","none");
                	$(".ipt-group").css("display","none");
                	$(".ipt-group-default").css("display","block"); */
                	/* 编辑完商品数量后要重新计算总量和总价 */
                	countNumAndPrice();
            	}
            	$("#doc-modal-loading").modal("close");
            },
            error: function(xhr){
            	$("#doc-modal-loading").modal("close");
            	if(operating=='delpro'){
            		 $("#doc-modal-1").modal('close');
            		if(xhr.status==0){
		        		$("#on-p-mes").html("网络异常,删除失败");
		        		$("#doc-modal-mes").modal("open");
	        		}else{
	        			$("#on-p-mes").html("系统错误,删除失败");
		        		$("#doc-modal-mes").modal("open");
	        		}
            	}else if(operating=='updnum'){
	            	if(xhr.status==0){
		        		$("#on-p-mes").html("网络异常,操作失败");
		        		$("#doc-modal-mes").modal("open");
	        		}else{
	        			$("#on-p-mes").html("系统错误,操作失败");
		        		$("#doc-modal-mes").modal("open");
	        		}
            	}
            }
        }); 
    }
    function Settlement(){
    	/* param = {"14":"2","2":"3"} */
    	$("#on-button-settle").attr({"disabled":"disabled"});
    	var param = "";
    	var boo = false;
    	$(".on-one-product input[type='checkbox']").each(function(){
    		/* jquery 1.6版本之后attr("checked")返回的不再是true和false */
    		if($(this).attr("checked")=="checked"){
    			var productStatus = $(this).parent().parent().find("#productStatus").val();
    			if(productStatus!=0){
    	    		boo = true;
    	    		return;
    			}
    			var productId= $(this).parent().parent().find("#productId").val();
    			var productNum = $(this).parent().parent().find("#productNum").val();
    			if(productNum<=0){
    				$("#on-button-settle").removeAttr("disabled");
    	    		/* 用户没有选中任何商品 */
    	    		$("#on-p-mes").html("数量小于等于0的商品不能提交！");
    	    		$("#doc-modal-mes").modal('open');
    	    		return;
    			}
    			param+="\""+productId+"\":\""+productNum+"\",";
    		}
    	});
    	if(boo){
    		$("#on-button-settle").removeAttr("disabled");
    		/* 用户没有选中任何商品 */
    		$("#on-p-mes").html("无效商品不能结算！");
    		$("#doc-modal-mes").modal('open');
    		return;
    	}
    	if(param!=""){
	    	param="{"+param.substring(0,param.length-1)+"}";
	    	param="param="+param;
	    	/* param="token=969a3b7a-2367-4bd0-aa44-11f24748b97a&&param="+param; */
	    	/* param = "{"+param+"\"countPrice\":\""+$("#on-count-price").html().replace("&yen;","")+"\"}"; */
	    	var url = "/OnlineStore/toOrderConfirm.do?"+param;
	    	$("#doc-modal-loading").modal("open");
	    	window.location.href = url; 
	    	return;
    	}else{
    		$("#on-button-settle").removeAttr("disabled");
    		/* 用户没有选中任何商品 */
    		$("#on-p-mes").html("您还没选择商品！");
    		$("#doc-modal-mes").modal('open');
    		return;
    	};
    };
    </script>
</body>

</html>
