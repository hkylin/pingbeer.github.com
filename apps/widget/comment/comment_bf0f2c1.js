define("comment",function(t,n,e){(function(){var n,o,i,m,r,s,d,c,a,u,l,h,p,f,v,w,g,b,C,x,k,y,I,$,F,T,z,q,A,D,M,O,P,S;n=t("zepto"),d=t("common"),c=t("db"),b=t("comment/commentitem.tpl"),c.getComments=c.registerMethod({url:"/comment/list/"+pageData.id,type:"get"}),a=d.calPageSize().width,o=null,i=null,r=n("#wrapper"),m=n(window),F=!1,C=[],s=[],T=[0,0,0],x=0,k=0,A=50,z=!1,M=[100,80,120],S=!0,q=!1,g=!1,$=function(){return pageData.comment&&!F?(o=n("<div id='comment-btns' class='comment-btns'>		<div id='comment-edit' class='comment-edit hidden'></div>		<div id='comment-btn' class='comment-btn closed'>			<span id='comment-btn-num' class='comment-btn-num'>0</span>		</div>	</div>"),i=n("<div id='comment-show' class='comment-show hidden'>		<ul id='comment-show-0' class='comment-show-item'></ul>		<ul id='comment-show-1' class='comment-show-item'></ul>		<ul id='comment-show-2' class='comment-show-item'></ul>	</div>"),o.appendTo(r),i.appendTo(r),p(),y(),F=!0):void 0},p=function(){var t,e,o;return t=n("#comment-btn"),e=n("#comment-edit"),o=n("#comment-btn-num"),t.on("tap",function(){var n;return n=!t.hasClass("closed"),n?(t.addClass("closed"),e.addClass("hidden"),o.removeClass("hidden"),i.addClass("hidden"),w(),D()):(t.removeClass("closed"),e.removeClass("hidden"),o.addClass("hidden"),i.removeClass("hidden"),O())})},y=function(){return q||z?void 0:(z=!0,c.getComments({data:{page:k+1,pagesize:A,sort:"asc"},success:function(t){var e;return t.data.items.length<1?void(q=!0):(e=t.data.total,e>99&&(e="99+"),n("#comment-btn-num").text(e),C=C.concat(t.data.items),k+=1)},error:function(t){return console.log(t)},complete:function(){return z=!1}}))},P=function(){return S=!0},D=function(){return S=!0,x=0,T=[0,0,0]},O=function(){return S&&(S=!1,!g)?h():void 0},h=function(){var t,e,o,i,m,r,d,c,u;if(x++,f(),C.length<1&&(g=!1,s.length>0&&(g=!0,requestAnimationFrame(h)),S=!0),!S){for(v(),o=c=0,u=T.length;u>c;o=++c)if(e=T[o],x>=e){if(i=I(),!i)continue;t=n("#comment-show-"+o),t.append(i.$commentItem),m=i.width+2.5*window.rem+200*Math.random(),r=m/M[o],d=(m+a)/M[o],T[o]=x+60*r,i.removeFrame=x+60*d+60,s.push(i),i.$commentItem.css({"transition-duration":""+d+"s","-webkit-transition-duration":""+d+"s","transition-property":"transform","-webkit-transition-property":"-webkit-transform","transition-timing-function":"linear","-webkit-transition-timing-function":"linear"}),function(t){return setTimeout(function(){return t.$commentItem.css({transform:"perspective(400px) translate3d(-"+(t.width+3.8*window.rem+a)+"px,0,0)","-webkit-transform":"perspective(400px) translate3d(-"+(t.width+3.8*window.rem+a)+"px,0,0)"})},10)}(i)}if(requestAnimationFrame(h),!C.length)return P()}},I=function(){var t,e,o,i;return o=C.splice(0,1)[0],(null!=o?o.content:void 0)?(o.content=d.str.xss(o.content),e=n(b(o,{C:d})),t=n("<div style='position:absolute;left:-9999px;'>"+e.clone().html()+"</div>"),t.appendTo(n(document.body)),i=t.width(),t.remove(),{width:i,$commentItem:e}):void 0},v=function(){return C.length<10?y():void 0},f=function(){var t,n,e,o;for(e=0,o=s.length;o>e;e++)n=s[e],(null!=n?n.removeFrame:void 0)<=x&&(n.$commentItem.remove(),t=s.indexOf(n),s.splice(t,1));return S===!0&&1>s?D():void 0},l=function(t){return C.unshift(t),O()},u=function(t){return C.push(t)},w=function(){var t,e,o,i,m,r;for(r=[],o=i=0,m=T.length;m>i;o=++i)e=T[o],t=n("#comment-show-"+o),r.push(t.children().remove());return r},e.exports={init:$,addCurComment:l,addComment:u}}).call(this)});